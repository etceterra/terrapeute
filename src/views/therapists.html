{% extends "base.html" %}
{% import 'partials/avatar.html' as macro %}

{% block meta_title %}Thérapeutes agréés ASCA autour de Genève{% endblock %}

{% block meta_description %}Prendre rendez-vous avec un thérapeute à Genève : accupressing, nutritionistes, massothérapeutes à Genève{% endblock %}

{% block content %}

{% if therapists | length %}
<div class=wrapper>
  <section id=content>
    {% if symptoms.length %}
    <aside class=block id=symptoms>
      <bockquote>Les troubles de {{ q }} sont associées aux
        {% set comma = joiner() %}
        {% for symptom in symptoms -%}
        <span>{{ comma() }} {{ symptom.name }}</span>
        {%- endfor %}.
      </bockquote>
      <h1>{{ therapists|length }} thérapeutes
        {% if therapy -%} en {{ therapy.name }} {%- endif %} peuvent vous accompagner dans les troubles de {{ q }}</h1>
    </aside>
    {% endif %}

    <section id=filters>
      <nav class=selector>
        <h4>Thérapie</h4>
        <div>
          {% for therapy in therapies %}
            <a href=/therapeutes/{{ therapy.slug }}{{ queryParams }} title="Thérapeutes en {{ therapy.name }}">{{ therapy.name }}</a>
          {% endfor %}
        </div>
      </nav>
    </section>

    <div class=wrapper>
      {% for therapist in therapists %}
      <article id="{{ therapist.id }}">
        <h1>{{ therapist.therapy }}</h1>
        {{ macro.avatar(therapist, therapist.name + ' : thérapeute à ' + therapist.city) }}
        <div>
          <h2>{{ therapist.name }}</h2>
          <p>{{ therapist.city }}</p>
          <p class=description>{{ therapist.description | truncate(120) }}</p>
        </div>
        <footer>
          {% for agreement in therapist.agreements %}
          <span class=tag title="{{ therapist.therapy }} agréé {{ agreement }}">{{ agreement | upper }}</span>
          {% endfor %}
        </footer>
        <a href={{ therapist.url }} title="{{ therapist.name }} est {# therapist.therapies_name | join(', ') #} à {{ therapist.city }}">Voir ce {{ therapist.therapies[0].name }} à {{ therapist.city }}</a>
      </article>
      {% endfor %}
    </div>
  </section>
  <aside id=map-container>
    <div id="map"></div>
  </aside>
</div>

{% else %}
  <section class=no-result>
    <p>Les troubles de <strong>{{ symptom }} sont trop spécifiques</strong> pour une recherche automatique. <a href="mailto:contact@terrapeute.ch?subject=Recherche un thérapeute pour {{ symptom }}">contactez-nous</a> afin de <strong>vous conseiller et vous orienter</strong> vers des thérapeutes <small>(toujours gratuitement !)</small>.
    </p>
    <a href="mailto:contact@terrapeute.ch?subject=Recherche un thérapeute pour {{ symptom }}" class="primary button calltoaction">Continuer ma recherche avec l'équipe</a>
  </section>
{% endif %}

<style>
  .wrapper {
    display: flex;
  }

  .no-result {
    padding: 10rem;
  }

  .block {
    background: #fff;
    padding: .5rem;
    margin: .5rem;
  }

  #symptoms span {
    font-weight: bold;
  }

  h1 {
    font-size: 1.2rem;
  }

  #map-container {
    width: 20rem;
  }

  #content {
    width: calc(100% - 20rem);
    padding-top: 1rem;
  }
  #content >.wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    flex-direction: row;
  }

  #map {
    min-height: 300px;
    height: 100vh;
    position: sticky !important;
    top: 0;
  }

  #filters {
    margin: .5rem 1rem;
  }

  article {
    position: relative;
    min-width: 22rem;
    display: inline-grid;
    grid-template:
      'avatar title'
      'avatar info'
      'avatar footer'
      / auto 1fr;
    grid-gap: 1rem;
    background-color: #fff;
    padding: 1rem;
    border: 1px solid #eee;
    border-radius: 3px;
    flex: 1 200px;
    margin: .5rem;
  }
  article p {
    margin: .3rem 0;
  }
  article h1,
  article h2 {
    margin: 0;
    padding: 0;
    font-size: 1em;
  }
  article h1 {
    font-weight: bold;
    font-size: 1.1rem;
    grid-area: title;
  }
  article h2 {
    font-size: 1rem;
  }
  article .avatar {
    grid-area: avatar;
    height: 12rem;
  }
  article picture {
    overflow: hidden;
  }
  article picture img {
    grid-area: img;
    width: 200px;
    height: 100%;
    object-fit: cover;
  }
  article > div {
    grid-area: info;
  }
  article > footer {
    grid-area: footer;
  }
  article .description {
    font-size: .9em;
    line-height: 1.2;
  }
  article > footer > div {
    margin-top: .7rem;
    padding-top: .7rem;
    border-top: 1px dashed #eee;
  }
  article a {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    text-indent: -999%;
  }
  article a:hover {
    box-shadow: 1px 1px 5px rgba(176, 176, 176, .3)
  }

  .leaflet-popup-content h4,
  .leaflet-popup-content h5,
  .leaflet-popup-content p {
    margin: .1rem !important;
  }
  .leaflet-popup-content {
    display: flex;
  }
  .leaflet-popup-content img {
    width: 100%;
  }
  .leaflet-popup-content aside {
    width: 100px;
    padding: .3rem;
  }
  .leaflet-popup-content h5,
  .leaflet-popup-content .button {
    font-size: .7rem;
    padding: .3rem 1rem;
    text-decoration: none;
  }

  .selector {
    position: relative;
    z-index: 1;
    display: inline;
  }
  .selector h4 {
    font-size: .8rem;
    border: 1px solid #aaa;
    border-radius: 1rem;
    display: inline;
    padding: .3rem .8rem;
  }
  .selector h4::after {
    content: " ▾";
  }
  .selector div {
    display: none;
    position: absolute;
    left: 0;
    top: 32px;
    background-color: white;
    max-height: 400px;
    padding: .5rem;
    overflow-y: scroll;
    box-shadow: 1px 1px 3px rgba(88, 88, 88, .2);
    width: max-content;
  }
  .selector:hover div {
    display: block;
  }
  .selector div a {
    display: block;
    text-decoration: none;
    color: inherit;
    padding-right: .2rem;
    transition: all .3s;
  }
  .selector div a:hover {
    padding-right: 0;
    padding-left: .2rem;
    color: #000;
  }

</style>
{% if therapists | length %}
  {% import "partials/map.html" as macro %}
  {{ macro.map(latlng=[46.5, 6.5], zoom=9) }}
<script>
  const therapists = [
    {% for therapist in therapists %}
      {
        id: "{{therapist.id}}",
        name: "{{therapist.name}}",
        therapy: "{{therapist.therapies[0].name}}",
        label: "{{therapist.name}} — {{ therapist.therapies[0].name }}",
        latlng: [{{ therapist.offices[0].location.coordinates }}],
        url: "{{therapist.url}}",
        photo: "{{ therapist.photoUrl }}",
      },
    {% endfor %}
  ]
  const markers = therapists.map(therapist => {
    const marker = L.marker(therapist.latlng)
    marker.bindPopup(`
      <aside>
        <img src="${ therapist.photo }">
      </aside>
      <section>
        <h4>${ therapist.name }</h4>
        <h5>${ therapist.therapy }</h5>
        <a class="button primary" href="${ therapist.url }{{ queryParams }}"><i class="far fa-id-card"></i> Consulter</a>
      </section>
    `)
    marker._therapist = therapist
    return marker
  })
  const markersGroup = L.featureGroup(markers)
  map.fitBounds(markersGroup.getBounds())
  markersGroup.addTo(map)
</script>
{% endif %}

{% endblock %}
